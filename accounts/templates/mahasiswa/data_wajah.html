{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Face Data" %}{% endblock %}
{% block page_title %}{% trans "Face Data" %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Card utama -->
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <!-- Header dengan judul dan status -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">{% trans "Face Dataset for Face Recognition" %}</h5>
                        {% if foto_count >= 10 %}
                            <span class="badge bg-success">{% trans "Dataset Complete" %}</span>
                        {% else %}
                            <span class="badge bg-warning">{% trans "Dataset Incomplete" %}</span>
                        {% endif %}
                    </div>
                    
                    <!-- Deskripsi -->
                    <p class="mb-4">
                        {% trans "Upload photos of your face from various angles and expressions to improve the accuracy of the face recognition attendance system." %}
                    </p>
                    
                    <!-- Statistik jumlah foto -->
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <div>
                                <strong>{% trans "Number of Photos:" %}</strong> {{ foto_count }} / 10 ({% trans "Minimum" %})
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status dataset terpenuhi -->
                    {% if foto_count >= 10 %}
                    <div class="alert alert-success">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <div>
                                {% trans "You have met the minimum required photos. The face recognition system is ready for attendance." %}
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-exclamation-circle-fill me-2"></i>
                            <div>
                                {% trans "You have not met the minimum required photos. Upload at least 10 face photos." %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Upload section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">{% trans "Upload Face Photo" %}</h6>
                        </div>
                        <div class="card-body text-center">
                            <!-- Area upload -->
                            <div class="border-2 border-dashed border-primary rounded p-5 mb-3" 
                                 style="border-style: dashed; background-color: #f8f9fa;">
                                <i class="bi bi-cloud-upload display-4 text-primary mb-3"></i>
                                <h5 class="mb-2">{% trans "Click to upload photo" %}</h5>
                                <p class="text-muted mb-4">{% trans "Format: JPG, PNG (Max Size: 5MB)" %}</p>
                                <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                    <i class="bi bi-upload me-1"></i> {% trans "Upload Photo" %}
                                </button>
                            </div>
                            
                            <!-- Informasi format -->
                            <small class="text-muted">
                                <i class="bi bi-lightbulb me-1"></i>
                                {% trans "Recommendation: Upload photos with various expressions (smile, neutral) and angles (front, left, right)" %}
                            </small>
                        </div>
                    </div>
                    
                    <!-- Galeri foto -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">{% trans "Photo Gallery" %} ({{ foto_count }})</h6>
                            {% if foto_count > 0 %}
                            <button class="btn btn-outline-danger btn-sm" onclick="hapusSemuaFoto()">
                                <i class="bi bi-trash me-1"></i> {% trans "Delete All" %}
                            </button>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <!-- Grid foto -->
                            <div class="row g-3" id="photoGallery">
                                {% if foto_wajah_list %}
                                    {% for foto in foto_wajah_list %}
                                    <div class="col-6 col-md-4 col-lg-2">
                                        <div class="photo-thumbnail position-relative" data-foto-id="{{ foto.id }}">
                                            {% if foto.file_path %}
                                                <img src="{{ foto.file_path.url }}" 
                                                     class="img-fluid rounded" 
                                                     alt="{% trans 'Face Photo' %} {{ forloop.counter }}"
                                                     style="width: 100%; height: 150px; object-fit: cover;">
                                            {% else %}
                                                <img src="{% static 'images/default-face.jpg' %}" 
                                                     class="img-fluid rounded" 
                                                     alt="{% trans 'Default Photo' %}"
                                                     style="width: 100%; height: 150px; object-fit: cover;">
                                            {% endif %}
                                            <button class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                                                    style="width: 30px; height: 30px; border-radius: 50%; padding: 0;"
                                                    onclick="hapusFoto('{{ foto.id }}')">
                                                <i class="bi bi-x"></i>
                                            </button>
                                            {% if foto.keterangan %}
                                            <div class="position-absolute bottom-0 start-0 w-100 bg-dark bg-opacity-75 text-white p-1">
                                                <small>{{ foto.keterangan|truncatechars:15 }}</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                <div class="col-12 text-center py-5">
                                    <i class="bi bi-images display-4 text-muted mb-3"></i>
                                    <h5 class="text-muted">{% trans "No face photos yet" %}</h5>
                                    <p class="text-muted">{% trans "Upload your first photo to get started" %}</p>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Info tambahan -->
                            <div class="alert alert-warning mt-4">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    <div>
                                        <strong>{% trans "Important:" %}</strong> {% trans "Face photos are used only for the face recognition attendance system. Make sure your photos are clear and your face is clearly visible." %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Upload -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">{% trans "Upload Face Photo" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadFotoForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="fotoWajah" class="form-label">{% trans "Select Photo" %}</label>
                        <input class="form-control" type="file" id="fotoWajah" accept="image/jpeg,image/png" required>
                        <div class="form-text">{% trans "Supported formats: JPG, PNG. Maximum size: 5MB." %}</div>
                    </div>
                    <div class="mb-3">
                        <label for="keterangan" class="form-label">{% trans "Description (Optional)" %}</label>
                        <input type="text" class="form-control" id="keterangan" placeholder="{% trans 'Example: Smiling photo, left angle photo' %}">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-primary-custom" onclick="uploadFoto()">{% trans "Upload" %}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .photo-thumbnail {
        transition: transform 0.2s;
        cursor: pointer;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        overflow: hidden;
    }
    
    .photo-thumbnail:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .photo-thumbnail img {
        object-fit: cover;
        width: 100%;
        height: 150px;
    }
    
    .border-dashed {
        border-style: dashed !important;
    }
    
    .btn-primary-custom {
        background-color: #4e73df;
        border-color: #4e73df;
        color: white;
    }
    
    .btn-primary-custom:hover {
        background-color: #2e59d9;
        border-color: #2e59d9;
        color: white;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Fungsi untuk upload foto
    function uploadFoto() {
        const fileInput = document.getElementById('fotoWajah');
        const keterangan = document.getElementById('keterangan').value;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        if (!fileInput.files[0]) {
            showNotification('{% trans "Please select a photo first!" %}', 'warning');
            return;
        }
        
        // Validasi ukuran file (max 5MB)
        if (fileInput.files[0].size > 5 * 1024 * 1024) {
            showNotification('{% trans "Photo size maximum 5MB!" %}', 'danger');
            return;
        }
        
        // Validasi tipe file
        const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg'];
        if (!allowedTypes.includes(fileInput.files[0].type)) {
            showNotification('{% trans "File format must be JPG or PNG!" %}', 'danger');
            return;
        }
        
        // Buat FormData
        const formData = new FormData();
        formData.append('foto_wajah', fileInput.files[0]);
        formData.append('keterangan', keterangan);
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        // Tampilkan loading
        showNotification('{% trans "Uploading photo..." %}', 'info');
        
        // Kirim ke server
        fetch('{% url "upload_foto_wajah" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                // Tutup modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
                modal.hide();
                
                // Reset form
                document.getElementById('uploadFotoForm').reset();
                
                // Refresh halaman setelah 1.5 detik
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification(data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('{% trans "An error occurred while uploading" %}', 'danger');
        });
    }
    
    // Fungsi untuk menghapus foto
    function hapusFoto(id) {
        if (confirm('{% trans "Are you sure you want to delete this photo?" %}')) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(`/api/hapus-foto-wajah/${id}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Refresh halaman setelah 1 detik
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showNotification(data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('{% trans "An error occurred while deleting" %}', 'danger');
            });
        }
    }
    
    // Fungsi untuk menghapus semua foto
    function hapusSemuaFoto() {
        if (confirm('{% trans "Are you sure you want to delete all photos? This action cannot be undone!" %}')) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch('{% url "hapus_semua_foto" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Refresh halaman setelah 1 detik
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showNotification(data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('{% trans "An error occurred while deleting" %}', 'danger');
            });
        }
    }
    
    // Fungsi untuk menampilkan notifikasi
    function showNotification(message, type) {
        // Hapus notifikasi lama
        const oldAlerts = document.querySelectorAll('.alert.position-fixed');
        oldAlerts.forEach(alert => alert.remove());
        
        // Tentukan icon berdasarkan type
        let icon = 'bi-info-circle-fill';
        if (type === 'success') icon = 'bi-check-circle-fill';
        else if (type === 'danger') icon = 'bi-exclamation-circle-fill';
        else if (type === 'warning') icon = 'bi-exclamation-triangle-fill';
        
        // Buat notifikasi baru
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alert.style.cssText = `
            z-index: 1060;
            top: 20px;
            right: 20px;
            min-width: 300px;
            max-width: 400px;
        `;
        
        alert.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi ${icon} me-2 fs-5"></i>
                <div class="flex-grow-1">${message}</div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        document.body.appendChild(alert);
        
        // Auto hide setelah 5 detik
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }
</script>
{% endblock %}
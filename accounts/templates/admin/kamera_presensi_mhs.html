{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block page_title %}{% trans "Student Attendance Camera" %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{% trans "Student Attendance List" %}</h5>
                    <span class="badge bg-secondary">{% trans "Total" %}: {{ total_mahasiswa }} {% trans "students"
                        %}</span>
                </div>
                <small class="text-muted">{% trans "Date" %}: {{ today|date:"d/m/Y" }}</small>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="presensi-table">
                        <thead>
                            <tr>
                                <th>{% trans "No" %}</th>
                                <th>{% trans "Check-in Image" %}</th>
                                <th>{% trans "Check-out Image" %}</th>
                                <th>{% trans "Name" %}</th>
                                <th>{% trans "Student ID" %}</th>
                                <th>{% trans "Class" %}</th>
                                <th>{% trans "Date" %}</th>
                                <th>{% trans "Check-in Time" %}</th>
                                <th>{% trans "Check-out Time" %}</th>
                                <th>{% trans "Action" %}</th>
                            </tr>
                        </thead>
                        <tbody id="student-table-body">
                            {% for data in presensi_data %}
                            <tr id="row-{{ data.mahasiswa.id }}">
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    {% if data.presensi and data.presensi.foto_checkin %}
                                    <img src="{{ data.presensi.foto_checkin.url }}"
                                        style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;"
                                        alt="{% trans 'Check-in Photo' %}" class="img-thumbnail">
                                    {% else %}
                                    <div class="avatar-circle">
                                        {% if data.mahasiswa.user.nama_lengkap %}
                                            {{ data.mahasiswa.user.nama_lengkap|slice:":1"|upper }}
                                        {% else %}
                                            {{ data.mahasiswa.user.username|slice:":1"|upper }}
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if data.presensi and data.presensi.foto_checkout %}
                                    <img src="{{ data.presensi.foto_checkout.url }}"
                                        style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;"
                                        alt="{% trans 'Check-out Photo' %}" class="img-thumbnail">
                                    {% else %}
                                    <div class="avatar-circle">
                                        <!-- PERBAIKAN: Ambil inisial dari nama lengkap -->
                                        {% if data.mahasiswa.user.nama_lengkap %}
                                            {{ data.mahasiswa.user.nama_lengkap|slice:":1"|upper }}
                                        {% else %}
                                            {{ data.mahasiswa.user.username|slice:":1"|upper }}
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ data.mahasiswa.user.nama_lengkap|default:data.mahasiswa.user.username }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ data.mahasiswa.user.nrp|default:"-" }}</span>
                                </td>
                                <td>{{ data.mahasiswa.kelas|default:"-" }}</td>
                                <td>{{ today|date:"d/m/Y" }}</td>
                                <td id="checkin-{{ data.mahasiswa.id }}">
                                    {% if data.presensi and data.presensi.jam_checkin %}
                                    <span class="badge bg-success">{{ data.presensi.jam_checkin|time:"H:i" }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td id="checkout-{{ data.mahasiswa.id }}">
                                    {% if data.presensi and data.presensi.jam_checkout %}
                                    <span class="badge bg-warning">{{ data.presensi.jam_checkout|time:"H:i" }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button"
                                            class="btn {% if data.is_checked_in %}btn-outline-secondary disabled{% else %}btn-success{% endif %} btn-checkin"
                                            data-mahasiswa-id="{{ data.mahasiswa.id }}"
                                            data-mahasiswa-nama="{% if data.mahasiswa.user.nama_lengkap %}{{ data.mahasiswa.user.nama_lengkap }}{% else %}{{ data.mahasiswa.user.username }}{% endif %}"
                                            {% if data.is_checked_in %}disabled{% endif %}
                                            title="{% trans 'Check-in' %}">
                                            <i class="fas fa-sign-in-alt"></i>
                                            <span class="d-none d-md-inline"> {% trans "Check-in" %}</span>
                                        </button>
                                        <button type="button"
                                            class="btn {% if not data.is_checked_in %}btn-outline-secondary disabled{% else %}btn-warning{% endif %} btn-checkout"
                                            data-mahasiswa-id="{{ data.mahasiswa.id }}"
                                            data-mahasiswa-nama="{% if data.mahasiswa.user.nama_lengkap %}{{ data.mahasiswa.user.nama_lengkap }}{% else %}{{ data.mahasiswa.user.username }}{% endif %}"
                                            data-presensi-id="{% if data.presensi %}{{ data.presensi.id }}{% endif %}"
                                            {% if not data.is_checked_in %}disabled{% endif %}
                                            title="{% trans 'Check-out' %}">
                                            <i class="fas fa-sign-out-alt"></i>
                                            <span class="d-none d-md-inline"> {% trans "Check-out" %}</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="10" class="text-center py-5">
                                    <div class="text-muted">
                                        <i class="fas fa-user-check fa-3x mb-3 opacity-25"></i>
                                        <h5 class="mb-2">{% trans "No approved students yet" %}</h5>
                                        <p>{% trans "All students whose registration approval status has been approved
                                            will appear here" %}</p>
                                        <a href="{% url 'approval_pendaftaran' %}" class="btn btn-outline-primary mt-2">
                                            <i class="fas fa-clipboard-check"></i> {% trans "Go to Registration
                                            Approval" %}
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    {% trans "Only displays students whose registration approval status has been APPROVED. Multiple
                    check-ins/outs per day are allowed, must check-out before checking in again. Data is reset every new
                    day." %}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Modal Kamera dengan Real-time Liveness Detection -->
<div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cameraModalLabel">{% trans "Attendance - Face Liveness Detection" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="camera-container mb-3">
                            <div class="card">
                                <div class="card-header bg-dark text-white py-2">
                                    <i class="fas fa-video"></i> {% trans "Live Camera - Real-time Detection" %}
                                </div>
                                <div class="card-body p-0" style="position: relative; background-color: #000;">
                                    <div style="position: relative; display: inline-block; width: 100%;">
                                        <video id="cameraPreview" autoplay playsinline
                                            style="width: 100%; height: 400px; object-fit: cover; background-color: #000; display: block;"
                                            class="video-normal"></video>
                                        <canvas id="cameraCanvas"
                                            style="position: absolute; top: 0; left: 0; width: 100%; height: 400px; display: block; cursor: none;"></canvas>
                                    </div>
                                    <div class="text-center bg-dark py-2">
                                        <div class="text-white small">
                                            <i class="fas fa-info-circle"></i> {% trans "System will auto-detect and
                                            save when face is verified as REAL" %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <canvas id="captureCanvas" style="display: none;"></canvas>
                        </div>
                        <div class="alert alert-info mt-3">
                            <strong><i class="fas fa-lightbulb"></i> Instructions:</strong>
                            <ul class="mb-0 mt-2">
                                <li><strong>Step 1:</strong> Position your face clearly</li>
                                <li><strong>Step 2:</strong> Blink naturally 2 times (Liveness Check)</li>
                                <li><strong>Step 3:</strong> System will verify your identity (Face Recognition)</li>
                                <li>If identity matches, attendance will be saved automatically</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="preview-container">
                            <div class="card">
                                <div class="card-header bg-info text-white py-2">
                                    <i class="fas fa-user"></i> {% trans "Student Info" %}
                                </div>
                                <div class="card-body text-center">
                                    <div class="mt-2">
                                        <div class="alert alert-info p-2 mb-2">
                                            <i class="fas fa-user-circle"></i>
                                            <strong id="mahasiswaInfo">-</strong>
                                        </div>
                                        <div class="alert alert-warning p-2 mb-2">
                                            <i class="fas fa-clock"></i>
                                            <strong id="actionType">-</strong>
                                        </div>
                                        <div class="alert alert-success p-2 mb-2">
                                            <i class="fas fa-video"></i>
                                            <strong>Status:</strong>
                                            <div id="detectionStatusBox"
                                                style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; font-size: 12px;">
                                                Waiting for detection...
                                            </div>
                                        </div>
                                        <div class="alert alert-light p-2">
                                            <small><i class="fas fa-shield-alt"></i> {% trans "Liveness detection
                                                ensures real attendance" %}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> {% trans "Cancel" %}
                </button>
                <small class="text-muted ms-2">Auto-saves on face verification</small>
            </div>
        </div>
    </div>
</div>

<style>
    .sidebar {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        z-index: 100;
        padding-top: 56px;
        box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
    }

    main {
        padding-top: 70px;
    }

    .btn-checkin:disabled,
    .btn-checkout:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .avatar-circle {
        width: 40px;
        height: 40px;
        background-color: #4e73df;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 16px;
    }

    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
        border-top: none;
    }

    .table td {
        vertical-align: middle;
        padding: 12px 8px;
    }

    .table tbody tr:hover {
        background-color: rgba(78, 115, 223, 0.05);
    }

    #cameraPreview {
        border-radius: 4px 4px 0 0;
    }

    .btn-checkin:not(:disabled):hover {
        background-color: #198754;
        border-color: #198754;
        color: white;
    }

    .btn-checkout:not(:disabled):hover {
        background-color: #ffc107;
        border-color: #ffc107;
        color: black;
    }

    .camera-container {
        position: relative;
        width: 100%;
    }

    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .video-normal {
    transform: scaleX(-1);          /* membalik mirror ‚Üí jadi normal */
    -webkit-transform: scaleX(-1);  /* untuk Safari/iOS */
    }

</style>

<script>
    // Global variables untuk real-time liveness detection
    let currentStream = null;
    let currentMahasiswaId = null;
    let currentMahasiswaNama = null;
    let currentAction = null;
    let captureCanvas = null;
    let drawCanvas = null;
    let livenessInterval = null;
    let isLivenessDetected = false;
    let presensiId = null;
    let lastDetectionResult = null;

    let cameraModal = null;
    document.addEventListener('DOMContentLoaded', function () {
        cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
        captureCanvas = document.getElementById('captureCanvas');
        drawCanvas = document.getElementById('cameraCanvas');
        console.log("Liveness Detection System initialized");
    });

    // Start camera dan real-time detection
    async function startCamera() {
        try {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            currentStream = await navigator.mediaDevices.getUserMedia({
                video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: "user" },
                audio: false
            });

            const video = document.getElementById('cameraPreview');
            video.srcObject = currentStream;

            isLivenessDetected = false;
            updateDetectionStatus('Initializing...', '#6c757d');

            // Mulai detection setelah 500ms
            setTimeout(startLivenessDetection, 500);

        } catch (err) {
            console.error('Camera error:', err);
            showNotification('Cannot access camera!', 'danger');
            if (cameraModal) cameraModal.hide();
        }
    }

    // Real-time liveness detection every 500ms
    function startLivenessDetection() {
        if (livenessInterval) clearInterval(livenessInterval);

        livenessInterval = setInterval(async function () {
            try {
                const video = document.getElementById('cameraPreview');
                if (!video || !video.srcObject) return;

                // Capture frame untuk detection
                captureCanvas.width = video.videoWidth;
                captureCanvas.height = video.videoHeight;
                const captureCtx = captureCanvas.getContext('2d');
                captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);

                const frameBase64 = captureCanvas.toDataURL('image/jpeg', 0.8);

                // Setup draw canvas dengan ukuran video
                drawCanvas.width = video.videoWidth;
                drawCanvas.height = video.videoHeight;

                // Kirim ke backend
                const response = await fetch('{% url "detect_liveness_frame" %}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        frame: frameBase64,
                        mahasiswa_id: currentMahasiswaId,
                        action: currentAction
                    })
                });

                const result = await response.json();
                lastDetectionResult = result;

                if (result.success) {
                    // Gambar hasil detection
                    drawDetectionResult(result);
                    updateDetectionUI(result);

                    // Auto save ketika REAL terdeteksi & belum disimpan
                    if (result.status === 'REAL' && !isLivenessDetected && result.verified) {
                        isLivenessDetected = true;
                        await autoSubmitPresensi(frameBase64, result);
                    }
                }
            } catch (error) {
                console.error('Detection error:', error);
            }
        }, 500);
    }

    // Gambar kotak wajah dan status di canvas overlay
    function drawDetectionResult(result) {
        const drawCtx = drawCanvas.getContext('2d');

        // Clear canvas
        drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);

        if (!result.face_detected || !result.box) {
            return;
        }

        const box = result.box;
        let boxColor = '#6c757d';
        let statusText = 'DETECTING...';
        let statusColor = '#6c757d';

        // Tentukan warna berdasarkan status
        if (result.status === 'REAL') {
            boxColor = '#28a745';
            statusColor = '#28a745';
            // Tampilkan PROSES FACE RECOGNITION dan Nama mahasiswa jika tersedia
            statusText = result.nama_mahasiswa ? result.nama_mahasiswa : 'PROSES FACE RECOGNITION';
        } else if (result.status === 'NOT_RECOGNIZED') {
            boxColor = '#fd7e14'; 
            statusColor = '#fd7e14';
            statusText = 'ID MISMATCH ‚úó';
        } else if (result.status === 'SPOOF') {
            boxColor = '#dc3545';
            statusColor = '#dc3545';
            statusText = 'SPOOF ‚úó';
        } else if (result.status === 'LIVENESS_CHECK') {
            boxColor = '#ffc107';
            statusColor = '#ffc107';
            statusText = `EYE BLINK (${result.blink_count}/2)`;
        }

        // Gambar kotak wajah
        drawCtx.strokeStyle = boxColor;
        drawCtx.lineWidth = 4;
        drawCtx.strokeRect(box.x, box.y, box.w, box.h);

        // Gambar background status text
        const fontSize = 18;
        const fontFamily = 'Arial';
        drawCtx.font = `bold ${fontSize}px ${fontFamily}`;
        const textMetrics = drawCtx.measureText(statusText);
        const textWidth = textMetrics.width;
        const textHeight = fontSize + 8;
        const textX = box.x;
        const textY = box.y - 10;

        // Background box
        drawCtx.fillStyle = boxColor;
        drawCtx.fillRect(textX, textY - textHeight, textWidth + 10, textHeight);

        // Text
        drawCtx.fillStyle = '#fff';
        drawCtx.fillText(statusText, textX + 5, textY - 5);

        // Tambahkan Sub-label jika REAL
        if (result.status === 'REAL' && result.nama_mahasiswa) {
            const subText = "PROSES FACE RECOGNITION";
            drawCtx.font = `bold 12px ${fontFamily}`;
            drawCtx.fillStyle = 'rgba(0,0,0,0.5)';
            drawCtx.fillRect(textX, textY, drawCtx.measureText(subText).width + 10, 20);
            drawCtx.fillStyle = '#fff';
            drawCtx.fillText(subText, textX + 5, textY + 15);
        }

        // Info di bawah kotak
        let infoText = `Liveness: ${result.spoof_score.toFixed(2)} | Blinks: ${result.blink_count}/2`;
        if (result.recognition_score) {
            infoText += ` | Match: ${(result.recognition_score * 100).toFixed(0)}%`;
        }
        
        drawCtx.font = `12px ${fontFamily}`;
        drawCtx.fillStyle = boxColor;
        drawCtx.fillRect(box.x, box.y + box.h + 5, drawCtx.measureText(infoText).width + 10, 20);
        drawCtx.fillStyle = '#fff';
        drawCtx.fillText(infoText, box.x + 5, box.y + box.h + 20);
    }

    // Update detection UI di panel info
    function updateDetectionUI(result) {
        let statusText = '';
        let color = '#6c757d';

        if (result.status === 'REAL') {
            const matchPercent = result.recognition_score ? (result.recognition_score * 100).toFixed(0) + '%' : 'N/A';
            const displayHeader = `‚è≥ PROSES FACE RECOGNITION...`;
            const displayName = result.nama_mahasiswa ? `<br/><strong style="font-size: 1.1em;">‚úì ${result.nama_mahasiswa}</strong>` : '';
            statusText = `<strong style="color: #28a745;">${displayHeader}</strong>${displayName}<br/>Identity matched (${matchPercent})<br/><small>Liveness: ${result.spoof_score.toFixed(2)}</small>`;
            color = '#28a745';
        } else if (result.status === 'NOT_RECOGNIZED') {
            statusText = `<strong style="color: #fd7e14;">‚úó NOT RECOGNIZED</strong><br/>Face does not match ID<br/><small>Please look straight at camera</small>`;
            color = '#fd7e14';
        } else if (result.status === 'SPOOF') {
            statusText = `<strong style="color: #dc3545;">‚úó SPOOF DETECTED</strong><br/>Fake face pattern detected<br/><small>Score: ${result.spoof_score.toFixed(3)}</small>`;
            color = '#dc3545';
        } else if (result.status === 'LIVENESS_CHECK') {
            statusText = `<strong style="color: #ffc107;">‚è≥ LIVENESS CHECK...</strong><br/>Blinks: ${result.blink_count}/2<br/><small>Score: ${result.spoof_score.toFixed(2)}</small>`;
            color = '#ffc107';
        } else if (result.status === 'NO_FACE') {
            statusText = `<strong style="color: #6c757d;">üìπ NO FACE</strong><br/>Position face to camera`;
            color = '#6c757d';
        }

        updateDetectionStatus(statusText, color);
    }

    function updateDetectionStatus(content, color) {
        const statusBox = document.getElementById('detectionStatusBox');
        if (statusBox) {
            statusBox.innerHTML = content;
            statusBox.style.borderLeft = `4px solid ${color}`;
            statusBox.style.backgroundColor = color + '15';
        }
    }

    // Auto submit presensi
    async function autoSubmitPresensi(frameBase64, result) {
        try {
            if (!frameBase64 || !currentMahasiswaId) return;

            if (livenessInterval) clearInterval(livenessInterval);

            updateDetectionStatus(`‚úì Saving to database...`, '#17a2b8');
            showNotification(`‚úì Welcome, ${result.nama_mahasiswa}! Saving attendance...`, 'success');

            // Jika backend sudah auto-save melalui detect_liveness_frame
            if (result.saved) {
                updateDetectionStatus(`‚úì Saved successfully!<br/>Name: ${result.nama_mahasiswa}`, '#28a745');
                showNotification(`‚úì ${currentAction.toUpperCase()} successful for ${result.nama_mahasiswa}`, 'success');

                if (currentAction === 'checkin') {
                    presensiId = result.presensi_id;
                    updatePresensiUI(currentMahasiswaId, 'checkin', {
                        presensi_id: result.presensi_id,
                        jam_checkin: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
                    });
                } else {
                    updatePresensiUI(currentMahasiswaId, 'checkout', {
                        presensi_id: result.presensi_id,
                        jam_checkout: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
                    });
                }

                setTimeout(() => { if (cameraModal) cameraModal.hide(); }, 1500);
            } else {
                // Fallback ke endpoint lama jika belum auto-save
                const endpoint = currentAction === 'checkin' ? '{% url "checkin_presensi" %}' : '{% url "checkout_presensi" %}';

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        mahasiswa_id: currentMahasiswaId,
                        foto: frameBase64,
                        presensi_id: presensiId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    updateDetectionStatus('‚úì Saved successfully!', '#28a745');
                    showNotification('‚úì Attendance saved successfully!', 'success');

                    if (currentAction === 'checkin') {
                        presensiId = data.data.presensi_id;
                        updatePresensiUI(currentMahasiswaId, 'checkin', data.data);
                    } else {
                        updatePresensiUI(currentMahasiswaId, 'checkout', data.data);
                    }

                    setTimeout(() => { if (cameraModal) cameraModal.hide(); }, 1500);
                } else {
                    showNotification('‚úó ' + data.message, 'danger');
                    isLivenessDetected = false;
                    setTimeout(startLivenessDetection, 1000);
                }
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('‚úó Error: ' + error.message, 'danger');
            isLivenessDetected = false;
            setTimeout(startLivenessDetection, 1000);
        }
    }

    // Event listeners
    document.addEventListener('click', function (e) {
        const checkinBtn = e.target.closest('.btn-checkin');
        if (checkinBtn && !checkinBtn.disabled) {
            currentMahasiswaId = checkinBtn.getAttribute('data-mahasiswa-id');
            currentMahasiswaNama = checkinBtn.getAttribute('data-mahasiswa-nama');
            currentAction = 'checkin';
            presensiId = null;
            document.getElementById('mahasiswaInfo').textContent = currentMahasiswaNama;
            document.getElementById('actionType').textContent = 'CHECK-IN';
            if (cameraModal) cameraModal.show();
        }

        const checkoutBtn = e.target.closest('.btn-checkout');
        if (checkoutBtn && !checkoutBtn.disabled) {
            currentMahasiswaId = checkoutBtn.getAttribute('data-mahasiswa-id');
            currentMahasiswaNama = checkoutBtn.getAttribute('data-mahasiswa-nama');
            currentAction = 'checkout';
            presensiId = checkoutBtn.getAttribute('data-presensi-id') || null;
            document.getElementById('mahasiswaInfo').textContent = currentMahasiswaNama;
            document.getElementById('actionType').textContent = 'CHECK-OUT';
            if (cameraModal) cameraModal.show();
        }
    });

    // Modal events
    const cameraModalElement = document.getElementById('cameraModal');
    if (cameraModalElement) {
        cameraModalElement.addEventListener('shown.bs.modal', startCamera);
        cameraModalElement.addEventListener('hidden.bs.modal', function () {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            if (livenessInterval) {
                clearInterval(livenessInterval);
                livenessInterval = null;
            }
            isLivenessDetected = false;
        });
    }

    function updatePresensiUI(mahasiswaId, action, data) {
        const row = document.getElementById(`row-${mahasiswaId}`);
        if (!row) return;

        const checkinCell = document.getElementById(`checkin-${mahasiswaId}`);
        const checkoutCell = document.getElementById(`checkout-${mahasiswaId}`);
        const checkinBtn = row.querySelector('.btn-checkin');
        const checkoutBtn = row.querySelector('.btn-checkout');

        if (action === 'checkin') {
            if (checkinCell) checkinCell.innerHTML = `<span class="badge bg-success">${data.jam_checkin}</span>`;
            if (checkinBtn) { checkinBtn.classList.add('disabled'); checkinBtn.disabled = true; }
            if (checkoutBtn) {
                checkoutBtn.classList.remove('disabled');
                checkoutBtn.disabled = false;
                checkoutBtn.setAttribute('data-presensi-id', data.presensi_id);
            }
        } else if (action === 'checkout') {
            if (checkoutCell) checkoutCell.innerHTML = `<span class="badge bg-warning">${data.jam_checkout}</span>`;
            if (checkoutBtn) { checkoutBtn.classList.add('disabled'); checkoutBtn.disabled = true; }
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie) {
            document.cookie.split(';').forEach(c => {
                const cookie = c.trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                }
            });
        }
        return cookieValue;
    }

    function showNotification(message, type = 'info') {
        document.querySelectorAll('.alert-notification').forEach(n => n.remove());
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-notification alert-dismissible fade show`;
        notification.style.cssText = `position: fixed; top: 20px; right: 20px; z-index: 1060; min-width: 320px; animation: slideIn 0.3s ease-out;`;
        notification.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        document.body.appendChild(notification);
        setTimeout(() => { if (notification.parentNode) notification.remove(); }, 5000);
    }

    setInterval(() => {
        fetch('{% url "get_presensi_today" %}').catch(e => console.log('Refresh check'));
    }, 30000);
</script>
{% endblock %}
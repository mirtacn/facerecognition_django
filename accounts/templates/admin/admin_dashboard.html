{% extends 'base.html' %}
{% load i18n static filters %}   {# 'filters' sesuai nama file filters.py tanpa .py #}

{% block page_title %}{% trans "Admin Dashboard" %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-subtitle mb-2 text-muted">{% trans "Today's Attendance" %}</h6>
                                    <h2 class="card-title mb-0" style="color: #f59e0b;">{{ today_present_count|default:0 }}</h2>
                                    <small class="text-muted">{% trans "From" %} {{ today_total_students|default:0 }} {% trans "students" %}</small>
                                </div>
                                <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
                                    <i class="bi bi-calendar-check fs-4 text-warning"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-subtitle mb-2 text-muted">{% trans "Average Attendance" %}</h6>
                                    <h2 class="card-title mb-2" style="color: #8b5cf6;">{{ avg_attendance_week|default:0 }}%</h2>
                                    <div class="d-flex align-items-center mt-2">
                                        <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                            <div class="progress-bar" style="width: {{ avg_attendance_week|default:0 }}%; background-color: #8b5cf6;"></div>
                                        </div>
                                        <small class="text-muted">{% trans "This week" %}</small>
                                    </div>
                                </div>
                                <div class="p-3 rounded-circle" style="background-color: rgba(139, 92, 246, 0.1);">
                                    <i class="bi bi-bar-chart-line fs-4" style="color: #8b5cf6;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-subtitle mb-2 text-muted">{% trans "Semester" %}</h6>
                                    <h5 class="card-title mb-3">{{ current_semester_name|default:"-" }}</h5>
                                    <div class="progress mb-2" style="height: 6px;">
                                        <div class="progress-bar bg-primary" style="width: {{ semester_progress|default:0 }}%;"></div>
                                    </div>
                                    <small class="text-muted">{{ weeks_remaining|default:0 }} {% trans "weeks remaining" %}</small>
                                </div>
                                <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                                    <i class="bi bi-calendar-week fs-4 text-primary"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-4">{% trans "Weekly Attendance per Program:" %}</h5>
                <div class="chart-container mb-4">
                    <div class="d-flex justify-content-between align-items-end mb-3" style="height: 200px;">
                        {% for weekday_num, entries in sorted_weekly %}
                        <div class="day-column text-center" style="flex: 1;"
                            data-bs-toggle="tooltip"
                            title="{{ day_labels|get_item:weekday_num|default:'-' }}"
                            data-weekday="{{ weekday_num }}">
                            <div class="bars-container d-flex justify-content-center align-items-end mb-2" style="height: 150px;">
                                <div class="bar-group d-flex align-items-end h-100">
                                    {% for entry in entries %}
                                    <div class="bar {{ entry.color }} mx-1"
                                        style="height: {{ entry.height }}%; width: 15px; min-height: 3px !important;"
                                        data-bs-toggle="tooltip"
                                        title="{{ entry.jenjang }}: {{ entry.hadir }} hadir ({{ entry.percentage }}%)">
                                    </div>
                                    {% empty %}
                                    <div class="bar bg-light mx-1" style="height: 0%; width: 15px;"></div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="day-label fw-bold">{{ day_labels|get_item:weekday_num }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                    <!-- Legend -->
                    <div class="d-flex justify-content-center mb-4">
                        <div class="d-flex flex-wrap justify-content-center gap-3">
                            {% for level in weekly_summary %}
                            <div class="d-flex align-items-center">
                                <div class="color-box {{ level.color }} me-2" style="width: 15px; height: 15px;"></div>
                                <span>{{ level.code }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Weekly Summary Table -->
                    <div class="mt-4">
                        <h6>{% trans "This Week's Attendance Details:" %}</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>{% trans "Level" %}</th>
                                        <th class="text-center">{% trans "Present Count" %}</th>
                                        <th class="text-center">{% trans "Total Students" %}</th>
                                        <th class="text-center">{% trans "Percentage" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for level in weekly_summary %}
                                    <tr>
                                        <td><span class="badge bg-{{ level.badge }}">{{ level.code }}</span></td>
                                        <td class="text-center">{{ level.present }}</td>
                                        <td class="text-center">{{ level.total }}</td>
                                        <td class="text-center">{{ level.percentage }}%</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-active fw-bold">
                                    <tr>
                                        <td>{% trans "Total" %}</td>
                                        <td class="text-center">{{ weekly_total.present|default:0 }}</td>
                                        <td class="text-center">{{ weekly_total.total|default:0 }}</td>
                                        <td class="text-center">{{ weekly_total.percentage|default:0 }}%</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Recent Activity -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">{% trans "Recent Activity" %}</h5>
                    <p class="text-muted small mb-4">{% trans "Real-time updates of student activities" %}</p>
                    <div class="activity-list">
                        {% for activity in recent_activities %}
                        <div class="activity-item {% if not forloop.last %}mb-3 pb-3 border-bottom{% endif %}">
                            <div class="d-flex">
                                <div class="avatar-sm me-3 bg-{{ activity.color }} bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center">
                                    <span class="text-{{ activity.color }} fw-bold">{{ activity.initials }}</span>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ activity.nama }}</h6>
                                    <small class="text-muted d-block">{% trans "Student ID:" %} {{ activity.nim }}</small>
                                    <p class="mb-0 small">{{ activity.action }}</p>
                                </div>
                                <div class="ms-auto text-end">
                                    <small class="text-muted">{{ activity.time_ago }}</small>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-4">{% trans "No recent activity" %}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">{% trans "Quick Actions:" %}</h5>
                    <div class="row g-3">
                        <div class="col-6">
                            <a href="{% url 'approval_pendaftaran' %}" class="btn btn-outline-primary w-100 py-3 d-flex flex-column align-items-center">
                                <i class="bi bi-check-circle fs-4 mb-2"></i>
                                {% trans "Registration Approval" %}
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{% url 'data_mahasiswa' %}" class="btn btn-outline-success w-100 py-3 d-flex flex-column align-items-center">
                                <i class="bi bi-people fs-4 mb-2"></i>
                                {% trans "Student Data" %}
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{% url 'monitor_durasi' %}" class="btn btn-outline-info w-100 py-3 d-flex flex-column align-items-center">
                                <i class="bi bi-clock fs-4 mb-2"></i>
                                {% trans "Duration Monitor" %}
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{% url 'kamera_presensi_mhs' %}" class="btn btn-outline-warning w-100 py-3 d-flex flex-column align-items-center">
                                <i class="bi bi-camera-video fs-4 mb-2"></i>
                                {% trans "Attendance Camera" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Day Details -->
<div class="modal fade" id="dayDetailModal" tabindex="-1" aria-labelledby="dayDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayDetailModalLabel">{% trans "Attendance Details - " %}<span id="modalDay"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>{% trans "Level" %}</th>
                                <th class="text-center">{% trans "Present" %}</th>
                                <th class="text-center">{% trans "Total" %}</th>
                                <th class="text-center">{% trans "%" %}</th>
                            </tr>
                        </thead>
                        <tbody id="modalDetailBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Styles & Scripts -->
<style>
    .card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.08)!important; }
    .day-column { cursor: pointer; transition: all 0.2s; }
    .day-column:hover { background: rgba(0,123,255,0.05); transform: scale(1.02); }
    .bar:hover { transform: scaleY(1.08); opacity: 0.9; }
    @media (max-width: 992px) { .chart-container .d-flex { flex-wrap: wrap; gap: 10px; } .day-column { flex: 1 1 45%; } }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

    // Realtime modal data
    const dayData = {{ day_data_json|safe }};// key: "0", "1", ..., "6"
    const modal = new bootstrap.Modal(document.getElementById('dayDetailModal'));
    const modalDay = document.getElementById('modalDay');
    const modalBody = document.getElementById('modalDetailBody');

    document.querySelectorAll('.day-column').forEach(col => {
        col.addEventListener('click', function() {
            const weekday = this.dataset.weekday;  // ambil dari data-weekday
            const dayName = this.querySelector('.day-label').textContent.trim();
            modalDay.textContent = dayName;

            const data = dayData[weekday] || [];
            let html = '', totHadir = 0, totMhs = 0;

            data.forEach(d => {
                html += `<tr><td><span class="badge bg-${d.badge}">${d.jenjang}</span></td><td class="text-center">${d.hadir}</td><td class="text-center">${d.total}</td><td class="text-center">${d.percentage}%</td></tr>`;
                totHadir += d.hadir;
                totMhs += d.total;
            });

            const totPerc = totMhs ? Math.round(totHadir / totMhs * 100) : 0;
            html += `<tr class="table-active fw-bold"><td>Total</td><td class="text-center">${totHadir}</td><td class="text-center">${totMhs}</td><td class="text-center">${totPerc}%</td></tr>`;

            modalBody.innerHTML = html || '<tr><td colspan="4" class="text-center py-3">{% trans "No data" %}</td></tr>';
            modal.show();
        });
    });
});
</script>
{% endblock %}
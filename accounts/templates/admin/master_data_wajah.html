{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block page_title %}{% trans "Student Face Data Master" %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 rounded-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-8">
                            <h6 class="text-muted text-uppercase small">{% trans "Total Students" %}</h6>
                            <h3 class="fw-bold mb-0">{{ total_mahasiswa }}</h3>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon-circle bg-primary bg-opacity-10 text-primary">
                                <i class="fas fa-users fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 rounded-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-8">
                            <h6 class="text-muted text-uppercase small">{% trans "Active Status" %}</h6>
                            <h3 class="fw-bold mb-0 text-success">{{ total_mahasiswa }}</h3>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon-circle bg-success bg-opacity-10 text-success">
                                <i class="fas fa-check-circle fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 rounded-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-8">
                            <h6 class="text-muted text-uppercase small">{% trans "Total Photos Stored" %}</h6>
                            <h3 class="fw-bold mb-0 text-info">{{ total_foto }}</h3>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon-circle bg-info bg-opacity-10 text-info">
                                <i class="fas fa-images fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 rounded-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-8">
                            <h6 class="text-muted text-uppercase small">{% trans "Average Photos/Student" %}</h6>
                            <h3 class="fw-bold mb-0 text-warning">
                                {% if total_mahasiswa > 0 %}
                                    {{ total_foto|floatformat:0 }}/{{ total_mahasiswa }}
                                {% else %}
                                    0
                                {% endif %}
                            </h3>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon-circle bg-warning bg-opacity-10 text-warning">
                                <i class="fas fa-calculator fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="card border-0 shadow-sm mb-4 rounded-3">
        <div class="card-body p-3">
            <form method="get" action="" class="search-form" id="searchForm">
                <div class="input-group">
                    <span class="input-group-text bg-transparent border-0">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" 
                           class="form-control border-0 ps-0" 
                           name="search" 
                           id="searchInput"
                           placeholder="{% trans 'Search by name, student ID, or program...' %}"
                           value="{{ search_query }}"
                           autocomplete="off">
                    {% if search_query %}
                    <button type="button" class="btn btn-link text-muted clear-search" id="clearSearch">
                        <i class="fas fa-times"></i>
                    </button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- Daftar Master Wajah -->
    <div class="card border-0 shadow-sm rounded-3">
        <div class="card-header bg-white border-0 rounded-top-3 py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">{% trans "List of Student Face Data:" %}</h5>
                <span class="badge bg-primary rounded-pill fs-6">{% trans "Total" %} {{ mahasiswa_list.count }} {% trans "data found" %}</span>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="py-3 ps-4" style="width: 15%;">{% trans "Profile Photo" %}</th>
                            <th class="py-3" style="width: 15%;">{% trans "Student Name" %}</th>
                            <th class="py-3" style="width: 10%;">{% trans "Student ID" %}</th>
                            <th class="py-3" style="width: 10%;">{% trans "Program" %}</th>
                            <th class="py-3" style="width: 10%;">{% trans "Level" %}</th>
                            <th class="py-3" style="width: 10%;">{% trans "Semester" %}</th>
                            <th class="py-3" style="width: 10%;">{% trans "Number of Photos" %}</th>
                            <th class="py-3" style="width: 10%;">{% trans "Status" %}</th>
                            <th class="py-3 pe-4" style="width: 10%;">{% trans "Action" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mahasiswa in mahasiswa_list %}
                        <tr class="align-middle">
                            <!-- Foto Profil -->
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    {% with mahasiswa.foto_wajah.all|slice:":3" as foto_list %}
                                    {% for foto in foto_list %}
                                    <div class="me-2">
                                        <div class="avatar-sm rounded-circle overflow-hidden border">
                                            {% if foto.file_path %}
                                            <img src="{{ foto.file_path.url }}" alt="{% trans 'Photo' %}" 
                                                class="img-fluid w-100 h-100 object-fit-cover"
                                                onerror="this.onerror=null;">
                                            {% else %}
                                            <div class="bg-secondary w-100 h-100 d-flex align-items-center justify-content-center">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="text-center">
                                        <div class="avatar-sm rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center border">
                                            <i class="fas fa-user text-white"></i>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% endwith %}
                                    {% if mahasiswa.foto_wajah.count > 3 %}
                                    <div class="ms-2">
                                        <span class="badge bg-primary rounded-circle p-1">+{{ mahasiswa.foto_wajah.count|add:"-3" }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <!-- Nama Mahasiswa -->
                            <td>
                                <div class="d-flex flex-column">
                                    <small class="mb-1">{{ mahasiswa.user.nama_lengkap }}</small>
                                </div>
                            </td>
                            
                            <!-- NRP -->
                            <td>
                                <span class="badge bg-light text-dark border font-monospace">{{ mahasiswa.user.nrp }}</span>
                            </td>
                            
                            <!-- Prodi -->
                            <td>
                                {% if mahasiswa.jurusan %}
                                <span class="badge bg-info text-white">
                                    {{ mahasiswa.jurusan }}
                                </span>
                                {% else %}
                                <span class="badge bg-secondary text-white">
                                    {% trans "Not filled" %}
                                </span>
                                {% endif %}
                            </td>
                            
                            <!-- Jenjang -->
                            <td>
                                <span class="badge bg-light text-dark border">
                                    {{ mahasiswa.jenjang_pendidikan.nama_jenjang }}
                                </span>
                            </td>
                            
                            <!-- Semester -->
                            <td>
                                <span class="badge bg-light text-dark border">
                                    {{ mahasiswa.semester.nama_semester }}
                                </span>
                            </td>
                            
                            <!-- Jumlah Foto -->
                            <td>
                                {% with jumlah_foto=mahasiswa.foto_wajah.count %}
                                <span class="badge bg-primary bg-opacity-10 text-primary border-0 px-3 py-2">
                                    <i class="fas fa-image me-1"></i>
                                    <small>{{ jumlah_foto }}</small> {% trans "Photos" %}
                                </span>
                                {% endwith %}
                            </td>
                            
                            <!-- Status -->
                            <td>
                                {% if mahasiswa.pengajuan_pendaftaran.status_pengajuan == 'disetujui' %}
                                <span class="badge bg-success text-white">
                                    <i class="fas fa-check me-1"></i> {% trans "Approved" %}
                                </span>
                                {% endif %}
                            </td>
                            
                            <!-- Aksi -->
                            <td class="pe-4">
                                <div class="btn-group btn-group-sm" role="group">
                                    <!-- Tombol Detail (Mata) -->
                                    <button type="button" 
                                            class="btn btn-outline-info btn-view-detail" 
                                            data-mahasiswa-id="{{ mahasiswa.id }}"
                                            title="{% trans 'Detail' %}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    
                                    <!-- Tombol Download -->
                                    <a href="{% url 'download_all_fotos' mahasiswa.id %}" 
                                       class="btn btn-outline-primary"
                                       title="{% trans 'Download Photos' %}">
                                        <i class="fas fa-download"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="text-muted">
                                    <i class="fas fa-user-slash fa-3x mb-3 opacity-25"></i>
                                    <h5 class="mb-2">{% trans "No student data" %}</h5>
                                    {% if search_query %}
                                    <p>{% trans "Try with different keywords" %}</p>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detail Wajah (Menggunakan modal popup AJAX JSON seperti sebelumnya) -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content rounded-3">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold" id="detailModalLabel">{% trans "Student Face Data Detail" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Loading Spinner -->
                <div id="loadingSpinner" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{% trans "Loading" %}...</span>
                    </div>
                    <p class="mt-2 text-muted">{% trans "Loading data" %}...</p>
                </div>
                
                <!-- Content will be loaded here -->
                <div id="modalContent" style="display: none;">
                    <div class="row g-0">
                        <!-- Left Column: Student Info -->
                        <div class="col-md-4 border-end bg-light">
                            <div class="p-4">
                                <!-- Nama Lengkap -->
                                <div class="mb-4">
                                    <h6 class="text-muted text-uppercase small mb-2">{% trans "Full Name" %}</h6>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-md rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center me-3">
                                            <i class="fas fa-user fs-5"></i>
                                        </div>
                                        <div>
                                            <h5 class="mb-0 fw-bold" id="modalNama">-</h5>
                                            <small class="text-muted" id="modalNRP">-</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Prodi & Jenjang -->
                                <div class="mb-4">
                                    <h6 class="text-muted text-uppercase small mb-2">{% trans "Program" %}</h6>
                                    <p class="mb-0 fw-semibold" id="modalProdi">-</p>
                                    
                                    <h6 class="text-muted text-uppercase small mt-3 mb-2">{% trans "Level/Semester" %}</h6>
                                    <p class="mb-0 fw-semibold" id="modalJenjangSemester">-</p>
                                </div>
                                
                                <!-- Separator -->
                                <hr class="my-4">
                                
                                <!-- Tanggal Pendaftaran & Status -->
                                <div class="row">
                                    <div class="col-6">
                                        <h6 class="text-muted text-uppercase small mb-2">{% trans "Registration Date" %}</h6>
                                        <p class="mb-0 fw-semibold" id="modalTanggalDaftar">-</p>
                                    </div>
                                    <div class="col-6">
                                        <h6 class="text-muted text-uppercase small mb-2">{% trans "Status" %}</h6>
                                        <p class="mb-0">
                                            <span class="badge" id="modalStatusBadge">-</span>
                                        </p>
                                    </div>
                                </div>
                                
                                <!-- Total Foto -->
                                <div class="mt-4">
                                    <h6 class="text-muted text-uppercase small mb-2">{% trans "Total Photos" %}</h6>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center me-2">
                                            <i class="fas fa-image"></i>
                                        </div>
                                        <h4 class="mb-0 fw-bold" id="modalTotalFoto">0</h4>
                                        <span class="ms-2 text-muted">{% trans "Photos" %}</span>
                                    </div>
                                </div>
                                
                                <!-- Download Button -->
                                <div class="mt-5 pt-4">
                                    <a href="#" 
                                       class="btn btn-success w-100 d-flex align-items-center justify-content-center py-3"
                                       id="modalDownloadBtn">
                                        <i class="fas fa-download me-2"></i>
                                        {% trans "Download All Photos" %}
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column: Gallery -->
                        <div class="col-md-8">
                            <div class="p-4">
                                <!-- Gallery Header -->
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div>
                                        <h5 class="mb-0 fw-bold" id="modalGalleryTitle">{% trans "Face Photo Gallery" %}</h5>
                                        <small class="text-muted" id="modalFotoCount">0 {% trans "photos" %}</small>
                                    </div>
                                </div>
                                
                                <!-- Gallery Grid -->
                                <div class="row g-3" id="fotoGallery">
                                    <!-- Photos will be loaded here -->
                                </div>
                                
                                <!-- Empty State -->
                                <div id="emptyGallery" class="text-center py-5" style="display: none;">
                                    <div class="py-5">
                                        <i class="fas fa-images fa-3x text-muted mb-3 opacity-25"></i>
                                        <h5 class="text-muted">{% trans "No photos stored yet" %}</h5>
                                        <p class="text-muted">{% trans "This student has not uploaded any face photos" %}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    border-radius: 12px !important;
    overflow: hidden;
}
    
.rounded-3 {
    border-radius: 12px !important;
}
    
.avatar-sm {
    width: 40px;
    height: 40px;
}
    
.icon-circle {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

/* Modal styling */
.modal-lg {
    max-width: 900px;
}

.avatar-md {
    width: 56px;
    height: 56px;
}

.avatar-sm {
    width: 40px;
    height: 40px;
}

/* Photo card styling */
.photo-card {
    border: 1px solid #e9ecef;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.2s;
    background: white;
}

.photo-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.photo-img {
    width: 100%;
    height: 180px;
    object-fit: cover;
    background-color: #f8f9fa;
}

.photo-info {
    padding: 12px;
    background: white;
}

.photo-date {
    font-size: 12px;
    color: #6c757d;
    margin-bottom: 4px;
}

.photo-desc {
    font-size: 13px;
    color: #495057;
    margin-bottom: 0;
    line-height: 1.3;
}

/* Grid layout */
.row-cols-md-2 > * {
    flex: 0 0 50%;
    max-width: 50%;
}

.row-cols-lg-3 > * {
    flex: 0 0 33.333333%;
    max-width: 33.333333%;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .modal-lg {
        max-width: 95%;
    }
    
    .border-end {
        border-right: none !important;
        border-bottom: 1px solid #dee2e6;
    }
    
    .row-cols-md-2 > *,
    .row-cols-lg-3 > * {
        flex: 0 0 100%;
        max-width: 100%;
    }
    
    .photo-img {
        height: 200px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {

    const clearSearchBtn = document.getElementById('clearSearch');
    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', function() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchForm').submit();
        });
    }

    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
    const modalContent = document.getElementById('modalContent');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const fotoGallery = document.getElementById('fotoGallery');
    const emptyGallery = document.getElementById('emptyGallery');
    
    // Event listener untuk tombol "Lihat"
    document.querySelectorAll('.btn-view-detail').forEach(button => {
        button.addEventListener('click', function() {
            const mahasiswaId = this.getAttribute('data-mahasiswa-id');
            loadMahasiswaDetail(mahasiswaId);
        });
    });
    
    function loadMahasiswaDetail(mahasiswaId) {
        // Reset modal content
        modalContent.style.display = 'none';
        loadingSpinner.style.display = 'block';
        fotoGallery.innerHTML = '';
        emptyGallery.style.display = 'none';
        
        // Show modal
        modal.show();
        
        // Fetch data from API
        fetch(`{% url 'get_foto_wajah_detail' 0 %}`.replace('0', mahasiswaId))
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate student info
                    document.getElementById('modalNama').textContent = data.mahasiswa.nama_lengkap;
                    document.getElementById('modalNRP').textContent = data.mahasiswa.nrp;
                    document.getElementById('modalProdi').textContent = data.mahasiswa.jurusan || '{% trans "No data" %}';
                    document.getElementById('modalJenjangSemester').textContent = 
                        `${data.mahasiswa.jenjang} - ${data.mahasiswa.semester}`;
                    document.getElementById('modalTanggalDaftar').textContent = data.mahasiswa.date_joined;
                    
                    // Status badge
                    const statusBadge = document.getElementById('modalStatusBadge');
                    statusBadge.textContent = data.mahasiswa.status_akun;
                    statusBadge.className = data.mahasiswa.is_active ? 'badge bg-success' : 'badge bg-danger';
                    
                    // Total foto
                    document.getElementById('modalTotalFoto').textContent = data.total_fotos;
                    document.getElementById('modalGalleryTitle').textContent = '{% trans "Face Photo Gallery" %}';
                    document.getElementById('modalFotoCount').textContent = `(${data.total_fotos} {% trans "photos" %})`;
                    
                    // Download button
                    const downloadBtn = document.getElementById('modalDownloadBtn');
                    downloadBtn.href = `{% url 'download_all_fotos' 0 %}`.replace('0', mahasiswaId);
                    
                    // Populate gallery with grid layout
                    if (data.total_fotos > 0) {
                        fotoGallery.innerHTML = '';
                        fotoGallery.className = 'row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3';
                        
                        data.fotos.forEach((foto, index) => {
                            const col = document.createElement('div');
                            col.className = 'col';
                            
                            col.innerHTML = `
                                <div class="photo-card h-100">
                                    <div class="photo-img-container">
                                        <img src="${foto.url}" 
                                             alt="{% trans 'Photo' %} ${index + 1}" 
                                             class="photo-img"
                                             onerror="this.src='{% static 'img/default-photo.jpg' %}'">
                                    </div>
                                    <div class="photo-info">
                                        <div class="photo-date">
                                            <i class="far fa-calendar me-1"></i>
                                            ${foto.created_at}
                                        </div>
                                        ${foto.keterangan ? 
                                            `<p class="photo-desc">${foto.keterangan}</p>` : 
                                            `<p class="photo-desc text-muted">{% trans "Registration photo" %} ${index + 1}</p>`
                                        }
                                    </div>
                                </div>
                            `;
                            fotoGallery.appendChild(col);
                        });
                        emptyGallery.style.display = 'none';
                    } else {
                        fotoGallery.innerHTML = '';
                        emptyGallery.style.display = 'block';
                    }
                    
                    // Hide loading, show content
                    loadingSpinner.style.display = 'none';
                    modalContent.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading data:', error);
                loadingSpinner.innerHTML = `
                    <div class="alert alert-danger m-4">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        {% trans "Failed to load data. Please try again." %}
                    </div>
                `;
            });
    }
});
</script>
{% endblock %}